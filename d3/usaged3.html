// D3.js based heatmap generated using data in MySQL database
// Adapted from https://www.d3-graph-gallery.com/graph/heatmap_style.html

<!DOCTYPE html>
<meta charset = "utf-8">

<!--Load D3.js-->
<script src="https://d3js.org/d3.v4.js"></script>

<!--Latency-->
<div id="latency"></div>

<!--TODO: BIBW, Palette-->

// JS
<script>
var margin = {top: 80, right: 25, bottom: 30, left: 60},
	width = 1200 - margin.left - margin.right,
	height = 1200 - margin.top - margin.bottom;

// Function to filter out data
function getFilteredData(data, benchtype) {
  return data.filter(function(e) {return e.bench_type == benchtype;});}

// latency graph object
var latency_graph = d3.select("#latency")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform", 
        "translate(" + margin.left + "," + margin.top + ")");

// data from MySQL
d3.json("getdata.php", function(error, data){
  // Row is nodeID
  var nodeX = d3.map(data, function(d){return d.node1_id;}).keys().sort(d3.ascending);
  var nodeY = d3.map(data, function(d){return d.node2_id;}).keys().sort(d3.ascending);

  // Build x scales and axis:
  var x = d3.scaleBand()
     .range([ 0, width ])
     .domain(nodeX)
     .padding(0.05);
  latency_graph.append("g")
     .style("font-size", 12)
     .attr("transform", "translate(0," + height + ")")
     .call(d3.axisBottom(x).tickSize(0))
     .select(".domain").remove()

  // Build y scales and axis:
  var y = d3.scaleBand()
     .range([ height, 0])
     .domain(nodeY)
     .padding(0.05);
  latency_graph.append("g")
     .style("font-size", 12)
     .call(d3.axisLeft(y).tickSize(0))
     .select(".domain").remove()

  // Build color scale:
  var latencyColor = d3.scaleLinear()
     .range(["white", "#69b3a2"])
     .domain([300,600])

  // TODO Create tooltip (data overlay):

  // TODO moveover, mousemove, mouseleave Eventhandlers:

  // Filter out data for LATENCY benchmark
  var latency_filtered = getFilteredData(data, "latency");

  // Add datapoints:
  data_latency.selectAll()
    .data(latency_filtered, function(d) {return d.node1_id+':'+d.node2_id;})
    .enter()
    .append("rect")
      .attr("x", function(d) {return x(d.node1_id) })
      .attr("y", function(d) {return y(d.node2_id) })
      .attr("rx", 4)
      .attr("ry", 4)
      .attr("width", x.bandwidth() )
      .attr("height", x.bandwidth() )
      .style("fill", function(d) {return latencyColor(d.result)} )
      .style("stroke-width", 4)
      .style("stroke", "none")
      .style("opacity", 0.8)
//    .on("mouseover", mouseover)
//    .on("mousemove", mousemove)
//    .on("mouseleave", mouseleave)
})
	

</script>
